############################################################
# 构建键码→ASCII 映射表到 0x90000000
# 不使用任何字符串或静态数据
############################################################

.global _start
_start:

    ########################################################
    # a0 = 映射表写入地址 0x90000000
    ########################################################
    lui   a0, 0x80000000 >> 12
    addi  a0, a0, 0



    li t0, 's'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 't'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 'a'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 'r'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 't'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, ':'
    sb t0,0(a0)
    addi a0,a0,1











############################################################
# 0C12: ESC, F1CF12 → 0
############################################################
    li t0, 0
    li t1, 13
map_zero_0_12:
    sb t0, 0(a0)
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_zero_0_12


############################################################
# 13: '`'
############################################################
    li t0, 0x60        # '`'
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 14C25: '1'..'='
# ASCII: '1'=49 到 '='=61，共 12 个
############################################################
    li t0, 49          # '1'
    li t1, 12
map_1_to_equal:
    sb t0, 0(a0)
    addi t0, t0, 1
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_1_to_equal


############################################################
# 26 BACKSPACE → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 27 TAB → 9
############################################################
    li t0, 9
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 28C40: qwertyuiop[]\
# 手动写入 ASCII 值（无字符串）
############################################################
    # q=113
    li t0, 113
    sb t0, 0(a0)
    addi a0, a0, 1

    # w=119
    li t0, 119
    sb t0, 0(a0)
    addi a0, a0, 1

    # e=101
    li t0, 101
    sb t0, 0(a0)
    addi a0, a0, 1

    # r=114
    li t0, 114
    sb t0, 0(a0)
    addi a0, a0, 1

    # t=116
    li t0, 116
    sb t0, 0(a0)
    addi a0, a0, 1

    # y=121
    li t0, 121
    sb t0, 0(a0)
    addi a0, a0, 1

    # u=117
    li t0, 117
    sb t0, 0(a0)
    addi a0, a0, 1

    # i=105
    li t0, 105
    sb t0, 0(a0)
    addi a0, a0, 1

    # o=111
    li t0, 111
    sb t0, 0(a0)
    addi a0, a0, 1

    # p=112
    li t0, 112
    sb t0, 0(a0)
    addi a0, a0, 1

    # [ = 91
    li t0, 91
    sb t0, 0(a0)
    addi a0, a0, 1

    # ] = 93
    li t0, 93
    sb t0, 0(a0)
    addi a0, a0, 1

    # \ = 92
    li t0, 92
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 41 CAPSLOCK → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 42C52: asdfghjkl;'
############################################################
    # a=97
    li t0, 97
    sb t0, 0(a0)
    addi a0, a0, 1

    # s=115
    li t0, 115
    sb t0, 0(a0)
    addi a0, a0, 1

    # d=100
    li t0, 100
    sb t0, 0(a0)
    addi a0, a0, 1

    # f=102
    li t0, 102
    sb t0, 0(a0)
    addi a0, a0, 1

    # g=103
    li t0, 103
    sb t0, 0(a0)
    addi a0, a0, 1

    # h=104
    li t0, 104
    sb t0, 0(a0)
    addi a0, a0, 1

    # j=106
    li t0, 106
    sb t0, 0(a0)
    addi a0, a0, 1

    # k=107
    li t0, 107
    sb t0, 0(a0)
    addi a0, a0, 1

    # l=108
    li t0, 108
    sb t0, 0(a0)
    addi a0, a0, 1

    # ; = 59
    li t0, 59
    sb t0, 0(a0)
    addi a0, a0, 1

    # ' = 39
    li t0, 39
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 53 ENTER → '\n' = 10
############################################################
    li t0, 10
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 54 SHIFT → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 55C64: zxcvbnm,./
############################################################
    # z=122
    li t0, 122
    sb t0, 0(a0)
    addi a0, a0, 1

    # x=120
    li t0, 120
    sb t0, 0(a0)
    addi a0, a0, 1

    # c=99
    li t0, 99
    sb t0, 0(a0)
    addi a0, a0, 1

    # v=118
    li t0, 118
    sb t0, 0(a0)
    addi a0, a0, 1

    # b=98
    li t0, 98
    sb t0, 0(a0)
    addi a0, a0, 1

    # n=110
    li t0, 110
    sb t0, 0(a0)
    addi a0, a0, 1

    # m=109
    li t0, 109
    sb t0, 0(a0)
    addi a0, a0, 1

    # , = 44
    li t0, 44
    sb t0, 0(a0)
    addi a0, a0, 1

    # . = 46
    li t0, 46
    sb t0, 0(a0)
    addi a0, a0, 1

    # / = 47
    li t0, 47
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 65C68: CTRL, unused, ALT, SPACE
############################################################
    sb zero, 0(a0)     # 65 CTRL
    addi a0, a0, 1

    sb zero, 0(a0)     # 66 unused
    addi a0, a0, 1

    sb zero, 0(a0)     # 67 ALT
    addi a0, a0, 1

    li t0, 32          # SPACE
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 69C72: 方向键 → 0
############################################################
    li t1, 4
map_zero_69_72:
    sb zero, 0(a0)
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_zero_69_72


############################################################
# 73 unused → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 74 ENTER → '\n'
############################################################
    li t0, 10
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 75C86: INS, DEL, PAUSE, PRTSC, HOME, END, PGUP, PGDN, NUMLOCK, SCRLOCK → 0
############################################################
    li t1, 12
map_zero_75_86:
    sb zero, 0(a0)
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_zero_75_86


############################################################
# 87C90 unused → 0
############################################################
    li t1, 4
map_zero_87_90:
    sb zero, 0(a0)
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_zero_87_90


############################################################
# 91C95: keypad symbols * / - . +
############################################################
    li t0, 42   # *
    sb t0, 0(a0)
    addi a0, a0, 1

    li t0, 47   # /
    sb t0, 0(a0)
    addi a0, a0, 1

    li t0, 45   # -
    sb t0, 0(a0)
    addi a0, a0, 1

    li t0, 46   # .
    sb t0, 0(a0)
    addi a0, a0, 1

    li t0, 43   # +
    sb t0, 0(a0)
    addi a0, a0, 1


############################################################
# 96C105: keypad 0C9
############################################################
    li t0, 48   # '0'
    li t1, 10
map_kp_num:
    sb t0, 0(a0)
    addi t0, t0, 1
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_kp_num


############################################################
# 106 WIN → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 107 unused → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 108 MENUKEY → 0
############################################################
    sb zero, 0(a0)
    addi a0, a0, 1


############################################################
# 109C255 → 0
############################################################
    li t1, 147
map_zero_rest:
    sb zero, 0(a0)
    addi a0, a0, 1
    addi t1, t1, -1
    bnez t1, map_zero_rest


############################################################
# 映射表构建完成
############################################################

############################################################
# 0) 初始化寄存器
############################################################

    # a0 = 显示输出地址 0x90010000
    lui   a0, 0x90010000 >> 12
    addi  a0, a0, 0

    # a1 = 键盘地址 0x90020000
    lui   a1, 0x90020000 >> 12
    addi  a1, a1, 0

    # a2 = 映射表地址 0x80000000
    lui   a2, 0x80000000 >> 12
    addi  a2, a2, 0




############################################################
# 1) 输出 "start:"（纯立即数）
############################################################

    li t0, 's'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 't'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 'a'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 'r'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, 't'
    sb t0,0(a0)
    addi a0,a0,1
    li t0, ':'
    sb t0,0(a0)
    addi a0,a0,1


############################################################
# 2) 构建键码→ASCII 映射表（256 字节）
#    这里先做恒等映射：ASCII = 键码
############################################################

    li t0, 0
    li t1, 256

keymap_loop:
    sb t0, 0(a2)
    addi a2, a2, 1
    addi t0, t0, 1
    addi t1, t1, -1
    bnez t1, keymap_loop

    # 映射表写完后，恢复 a2 = 0x80000000
    lui   a2, 0x80000000 >> 12
    addi  a2, a2, 0


############################################################
# 3) 主循环：只做一件事 → 轮询事件标志
############################################################

poll_loop:
    lb t0, 2(a1)          # 读取事件标志（bit16 → byte2）
    beqz t0, poll_loop    # 为 0 → 无事件 → 继续轮询

    j handle_event        # 非 0 → 有事件 → 处理


############################################################
# 4) 处理程序
############################################################
handle_event:

    ########################################################
    # 写任意值触发硬件加载下一事件
    ########################################################
    sb zero, 0(a1)

    ########################################################
    # 读取键码和释放标志
    ########################################################
    lb t3, 0(a1)          # t3 = 键码
    lb t4, 1(a1)          # t4 = 释放标志（非 0 = 释放）

    bnez t4, poll_loop    # 如果是释放事件 → 忽略


    ########################################################
    # 按下事件：解码 ASCII
    ########################################################
    add t5, a2, t3        # t5 = 映射表地址 + 键码
    lbu t6, 0(t5)         # t6 = ASCII


    ########################################################
    # 输出到终端
    ########################################################
    sb t6, 0(a0)
    addi a0, a0, 1        # 输出指针 +1


    ########################################################
    # 回主循环
    ########################################################
    j poll_loop


done:
    j done
